<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Pix - Modo Mínimo Compatível</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 20px auto; padding: 20px; background: #f0f0f0; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select { width: 100%; padding: 10px; margin-top: 5px; }
    button { width: 100%; padding: 12px; margin-top: 15px; font-weight: bold; cursor: pointer; }
    #qrcode { margin-top: 20px; text-align: center; }
    .pix-code { background: #fff; border: 1px solid #ccc; padding: 10px; font-family: monospace; word-break: break-word; margin-top: 15px; }
    .btn-group button { width: 49%; display: inline-block; }
  </style>
</head>
<body>

<h2>Pix Compatível - Cópia e Cola + QR</h2>

<label>Tipo da chave Pix:</label>
<select id="tipo">
  <option value="">Selecione</option>
  <option value="cpf">CPF</option>
  <option value="cnpj">CNPJ</option>
  <option value="telefone">Telefone</option>
  <option value="email">E-mail</option>
  <option value="aleatoria">Chave Aleatória</option>
</select>

<label>Chave Pix:</label>
<input id="chave" maxlength="77" placeholder="Digite sua chave Pix" />

<label>Txid (opcional):</label>
<input id="txid" maxlength="25" placeholder="Ex: PEDIDO123" />

<label>Valor (opcional):</label>
<input id="valor" type="number" step="0.01" placeholder="Ex: 49.90" />

<button onclick="gerar()">Gerar QR Code e Cópia e Cola</button>

<div id="qrcode"></div>
<div class="pix-code" id="emv"></div>
<div class="btn-group">
  <button onclick="copiar()">📋 Copiar código Pix</button>
  <button onclick="baixar()">⬇️ Baixar QR Code</button>
</div>

<script>
let imgBase64 = "";

function crc16(str) {
  let crc = 0xFFFF;
  for (let i = 0; i < str.length; i++) {
    crc ^= str.charCodeAt(i) << 8;
    for (let j = 0; j < 8; j++) {
      crc = (crc & 0x8000) ? ((crc << 1) ^ 0x1021) : (crc << 1);
      crc &= 0xFFFF;
    }
  }
  return crc.toString(16).toUpperCase().padStart(4, '0');
}

function gerar() {
  const tipo = document.getElementById("tipo").value;
  let chave = document.getElementById("chave").value.trim();
  const txid = document.getElementById("txid").value.trim();
  const valor = document.getElementById("valor").value.trim();

  if (!tipo || !chave) return alert("Preencha tipo e chave Pix.");

  if (tipo === "telefone") {
    chave = chave.replace(/\D/g, "");
    if (!chave.startsWith("55")) chave = "55" + chave;
    chave = "+" + chave;
  } else if (tipo === "cpf" || tipo === "cnpj") {
    chave = chave.replace(/\D/g, "");
  }

  const gui = "BR.GOV.BCB.PIX";
  const merchantAccount = "00" + "14" + gui + "01" + chave.length.toString().padStart(2, '0') + chave;
  const merchantField = "26" + merchantAccount.length.toString().padStart(2, '0') + merchantAccount;

  let payload = "000201" + merchantField +
                "52040000" +
                "5303986" +
                "5802BR" +
                "5901N" +
                "6001C";

  if (valor && !isNaN(parseFloat(valor))) {
    const valorFmt = parseFloat(valor).toFixed(2);
    payload += "54" + valorFmt.length.toString().padStart(2, '0') + valorFmt;
  }

  if (txid) {
    const ad = "05" + txid.length.toString().padStart(2, '0') + txid;
    payload += "62" + ad.length.toString().padStart(2, '0') + ad;
  } else {
    payload += "62070503***";
  }

  payload += "6304" + crc16(payload);

  document.getElementById("emv").textContent = payload;

  QRCode.toDataURL(payload, {
    errorCorrectionLevel: 'M',
    margin: 4,
    scale: 8
  }, function (err, url) {
    if (err) return alert("Erro ao gerar QR Code.");
    imgBase64 = url;
    const img = new Image();
    img.src = url;
    img.alt = "QR Code Pix";
    img.style.maxWidth = "100%";
    const qrDiv = document.getElementById('qrcode');
    qrDiv.innerHTML = "";
    qrDiv.appendChild(img);
  });
}

function copiar() {
  const codigo = document.getElementById("emv").textContent;
  navigator.clipboard.writeText(codigo).then(() => {
    alert("Código Pix copiado com sucesso!");
  });
}

function baixar() {
  if (!imgBase64) return alert("Gere um QR Code antes de baixar.");
  const a = document.createElement('a');
  a.href = imgBase64;
  a.download = "qrcode_pix.png";
  a.click();
}
</script>

</body>
</html>
