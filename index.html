<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerador Pix EMV V√°lido</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background: #f7f7f7; }
    label { display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 20px; padding: 10px; width: 100%; font-weight: bold; }
    #qrcode { margin-top: 20px; text-align: center; }
    .pix-code { font-family: monospace; background: #fff; padding: 10px; margin-top: 10px; border: 1px solid #ccc; word-break: break-word; }
  </style>
</head>
<body>

<h2>Gerador de QR Code Pix ‚Äì EMV v√°lido</h2>

<label>Nome do recebedor (at√© 25 letras):</label>
<input id="nome" maxlength="25" placeholder="Ex: JOAO SILVA" />

<label>Cidade (at√© 15 letras):</label>
<input id="cidade" maxlength="15" placeholder="Ex: RIO DE JANEIRO" />

<label>Tipo de chave Pix:</label>
<select id="tipo">
  <option value="">Selecione</option>
  <option value="cpf">CPF</option>
  <option value="cnpj">CNPJ</option>
  <option value="telefone">Telefone</option>
  <option value="email">E-mail</option>
  <option value="aleatoria">Chave Aleat√≥ria</option>
</select>

<label>Chave Pix (sem s√≠mbolos):</label>
<input id="chave" maxlength="77" placeholder="Ex: 5521999999999 ou seu@email.com" />

<label>Valor (opcional):</label>
<input id="valor" type="number" step="0.01" placeholder="Ex: 25.00" />

<label>Identificador da transa√ß√£o (txid ‚Äì opcional, at√© 25 caracteres):</label>
<input id="txid" maxlength="25" placeholder="Ex: PEDIDO123" />

<button onclick="gerar()">üîç Gerar QR Code Pix</button>

<div id="qrcode"></div>
<div class="pix-code" id="emv"></div>

<script>
function crc16(str) {
  let crc = 0xFFFF;
  for (let i = 0; i < str.length; i++) {
    crc ^= str.charCodeAt(i) << 8;
    for (let j = 0; j < 8; j++) {
      if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021;
      else crc <<= 1;
      crc &= 0xFFFF;
    }
  }
  return crc.toString(16).toUpperCase().padStart(4, '0');
}

function gerar() {
  const nome = document.getElementById("nome").value.trim().toUpperCase();
  const cidade = document.getElementById("cidade").value.trim().toUpperCase();
  const tipo = document.getElementById("tipo").value;
  const chave = document.getElementById("chave").value.trim();
  const valor = document.getElementById("valor").value.trim();
  const txid = document.getElementById("txid").value.trim();

  if (!nome || !cidade || !tipo || !chave) {
    alert("Preencha os campos obrigat√≥rios: nome, cidade, tipo e chave Pix.");
    return;
  }

  let chaveFormatada = chave;
  if (tipo === "telefone") {
    chaveFormatada = chave.replace(/\D/g, "");
    if (!chaveFormatada.startsWith("55")) chaveFormatada = "55" + chaveFormatada;
  } else if (tipo === "cpf" || tipo === "cnpj") {
    chaveFormatada = chave.replace(/\D/g, "");
  }

  const gui = "br.gov.bcb.pix";
  const guiField = "00" + "14" + gui;
  const chaveField = "01" + chaveFormatada.length.toString().padStart(2, "0") + chaveFormatada;
  const merchantAccountInfo = guiField + chaveField;
  const merchantField = "26" + merchantAccountInfo.length.toString().padStart(2, "0") + merchantAccountInfo;

  let payload = "000201";
  payload += "010211"; // QR Est√°tico
  payload += merchantField;
  payload += "52040000";
  payload += "5303986";
  if (valor) {
    const val = parseFloat(valor).toFixed(2);
    payload += "54" + val.length.toString().padStart(2, "0") + val;
  }
  payload += "5802BR";
  payload += "59" + nome.length.toString().padStart(2, '0') + nome;
  payload += "60" + cidade.length.toString().padStart(2, '0') + cidade;

  if (txid) {
    const tx = "05" + txid.length.toString().padStart(2, '0') + txid;
    payload += "62" + tx.length.toString().padStart(2, '0') + tx;
  }

  payload += "6304";
  payload += crc16(payload);

  document.getElementById("emv").innerText = payload;
  document.getElementById("qrcode").innerHTML = "";

  QRCode.toCanvas(document.createElement("canvas"), payload, { width: 256 }, function (err, canvas) {
    if (!err) document.getElementById("qrcode").appendChild(canvas);
  });
}
</script>

</body>
</html>
