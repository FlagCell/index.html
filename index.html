<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>QR Code Pix - EMV v√°lido</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 20px; background: #f5f5f5; }
    label { display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; }
    button { width: 100%; padding: 12px; margin-top: 20px; font-weight: bold; }
    #qrcode { margin-top: 20px; text-align: center; }
    .pix-code { background: #fff; border: 1px solid #ccc; padding: 10px; margin-top: 15px; font-family: monospace; word-break: break-word; }
  </style>
</head>
<body>

<h2>Gerador QR Code Pix (Padr√£o Banco Central)</h2>

<label>Nome do recebedor (at√© 25 caracteres):</label>
<input id="nome" maxlength="25" placeholder="Ex: JOAO SILVA" />

<label>Cidade (at√© 15 caracteres):</label>
<input id="cidade" maxlength="15" placeholder="Ex: RIO DE JANEIRO" />

<label>Tipo de chave Pix:</label>
<select id="tipo">
  <option value="">Selecione</option>
  <option value="cpf">CPF</option>
  <option value="cnpj">CNPJ</option>
  <option value="telefone">Telefone</option>
  <option value="email">E-mail</option>
  <option value="aleatoria">Chave Aleat√≥ria</option>
</select>

<label>Chave Pix:</label>
<input id="chave" maxlength="77" placeholder="Ex: 5521999999999 ou email" />

<label>Valor (opcional):</label>
<input id="valor" type="number" step="0.01" placeholder="Ex: 25.00" />

<label>Identificador da transa√ß√£o (Txid - opcional):</label>
<input id="txid" maxlength="25" placeholder="Ex: PEDIDO123" />

<button onclick="gerar()">üîç Gerar QR Code Pix</button>

<div id="qrcode"></div>
<div class="pix-code" id="emv"></div>

<script>
function crc16(str) {
  let crc = 0xFFFF;
  for (let i = 0; i < str.length; i++) {
    crc ^= str.charCodeAt(i) << 8;
    for (let j = 0; j < 8; j++) {
      if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021;
      else crc <<= 1;
      crc &= 0xFFFF;
    }
  }
  return crc.toString(16).toUpperCase().padStart(4, '0');
}

function gerar() {
  const nome = document.getElementById("nome").value.trim().toUpperCase();
  const cidade = document.getElementById("cidade").value.trim().toUpperCase();
  const tipo = document.getElementById("tipo").value;
  const chave = document.getElementById("chave").value.trim();
  const valor = document.getElementById("valor").value.trim();
  const txid = document.getElementById("txid").value.trim();

  if (!nome || !cidade || !tipo || !chave) {
    alert("Preencha todos os campos obrigat√≥rios.");
    return;
  }

  let chaveFormatada = chave;
  if (tipo === "telefone") {
    chaveFormatada = chave.replace(/\D/g, "");
    if (!chaveFormatada.startsWith("55")) chaveFormatada = "55" + chaveFormatada;
  } else if (tipo === "cpf" || tipo === "cnpj") {
    chaveFormatada = chave.replace(/\D/g, "");
  }

  const gui = "br.gov.bcb.pix";
  const guiField = "00" + "14" + gui;
  const chaveField = "01" + chaveFormatada.length.toString().padStart(2, "0") + chaveFormatada;
  const merchantAccount = guiField + chaveField;
  const merchantField = "26" + merchantAccount.length.toString().padStart(2, "0") + merchantAccount;

  let payload = "000201";
  payload += "010211"; // QR Est√°tico
  payload += merchantField;
  payload += "52040000";
  payload += "5303986";
  if (valor) {
    const val = parseFloat(valor).toFixed(2);
    payload += "54" + val.length.toString().padStart(2, "0") + val;
  }
  payload += "5802BR";
  payload += "59" + nome.length.toString().padStart(2, "0") + nome;
  payload += "60" + cidade.length.toString().padStart(2, "0") + cidade;

  if (txid) {
    const tx = "05" + txid.length.toString().padStart(2, "0") + txid;
    payload += "62" + tx.length.toString().padStart(2, "0") + tx;
  }

  payload += "6304";
  payload += crc16(payload);

  document.getElementById("emv").innerText = payload;

  // Gera√ß√£o da imagem do QR Code com corre√ß√£o
  QRCode.toDataURL(payload, {
    errorCorrectionLevel: 'M',
    margin: 4,
    scale: 8
  }, function (err, url) {
    if (err) return alert("Erro ao gerar QR Code.");
    const img = document.createElement('img');
    img.src = url;
    img.alt = "QR Code Pix";
    img.style.maxWidth = "100%";
    const qrDiv = document.getElementById('qrcode');
    qrDiv.innerHTML = "";
    qrDiv.appendChild(img);
  });
}
</script>

</body>
</html>
